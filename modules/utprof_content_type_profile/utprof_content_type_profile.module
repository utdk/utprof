<?php

/**
 * @file
 * Contains utprof content type .module file.
 */

use Drupal\Core\File\FileSystemInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Language\Language;
use Drupal\file\Entity\File;
use Drupal\media\Entity\Media;
use Drupal\node\Entity\Node;
use Drupal\utprof_content_type_profile\Form\FormAlter;
use Drupal\utprof_content_type_profile\ProfileContentTypeHelper;

/**
 * Implements hook_theme().
 */
function utprof_content_type_profile_theme() {
  return [
    'node__utprof_profile' => [
      'template' => 'node--utprof-profile--full',
      'base hook' => 'node',
    ],
    'node__utprof_profile__utexas_basic' => [
      'template' => 'node--utprof-profile--utexas-basic',
      'base hook' => 'node',
    ],
    'node__utprof_profile__utexas_prominent' => [
      'template' => 'node--utprof-profile--utexas-prominent',
      'base hook' => 'node',
    ],
    'node__utprof_profile__utexas_name_only' => [
      'template' => 'node--utprof-profile--utexas-name-only',
      'base hook' => 'node',
    ],
    'field__node__utprof_profile' => [
      'template' => 'field--node--utprof-profile',
      'base hook' => 'field',
    ],
  ];
}

/**
 * Implements hook_preprocess_node().
 */
function utprof_content_type_profile_preprocess_node(&$variables) {
  $node = $variables['elements']['#node'];
  $type = $node->getType();
  $view_mode = $variables['view_mode'];

  if ($type !== 'utprof_profile') {
    return;
  }

  $variables['basic_media'] = ProfileContentTypeHelper::getBasicMedia($node);
  $variables['building_information'] = ProfileContentTypeHelper::getBuildingInformation($node);
  $variables['contact_form_link'] = ProfileContentTypeHelper::getContactLink($node);
  $variables['directory_link'] = ProfileContentTypeHelper::getDirectoryLink($node);
  $variables['has_contact_info'] = ProfileContentTypeHelper::hasContactInfoFields($node);
  $variables['phone_link'] = ProfileContentTypeHelper::getPhone($node);
  $variables['prepared_basic_media'] = ProfileContentTypeHelper::getListingBasicMedia($node);
  $variables['prepared_title'] = ProfileContentTypeHelper::getPreparedTitle($node);

  switch ($view_mode) {
    case 'full':
      $variables['#attached']['library'][] = 'utprof_content_type_profile/node-display';
      break;

    case 'utexas_basic':
      $variables['#attached']['library'][] = 'utprof_content_type_profile/view-mode-utexas-basic';
      break;

    case 'utexas_name_only':
      $variables['#attached']['library'][] = 'utprof_content_type_profile/view-mode-utexas-name-only';
      break;

    case 'utexas_prominent':
      $variables['#attached']['library'][] = 'utprof_content_type_profile/view-mode-utexas-prominent';
      break;
  }
}

/**
 * Implements hook_form_alter().
 */
function utprof_content_type_profile_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (in_array($form_id, ['node_utprof_profile_edit_form', 'node_utprof_profile_form'])) {
    $alter = \Drupal::classResolver(FormAlter::class);
    $alter->alterProfileNodeForm($form, $form_state, $form_id);
  }
}

/**
 * Helper function to create a media item.
 *
 * @param array $image_metadata
 *   Key-value pair for a media item.
 *
 * @return int
 *   The media MID.
 */
function _utprof_content_type_profile_create_media(array $image_metadata) {
  $file_system = \Drupal::service('file_system');
  $filedir = 'public://utexas_devel/';
  $file_system->prepareDirectory($filedir, FileSystemInterface::CREATE_DIRECTORY);
  $image = File::create();
  $image->setFileUri($image_metadata['filepath']);
  $image->setOwnerId(\Drupal::currentUser()->id());
  $image->setMimeType(\Drupal::service('file.mime_type.guesser')->guess($image_metadata['filepath']));
  $image->setFileName($file_system->basename($image_metadata['filepath']));
  $destination_dir = 'public://generated_sample';
  $file_system->prepareDirectory($destination_dir, FileSystemInterface::CREATE_DIRECTORY);
  $destination = $destination_dir . '/' . basename($image_metadata['filepath']);
  $file = file_copy($image, $destination);
  $image_media = Media::create([
    'name' => $image_metadata['filename'],
    'bundle' => 'utexas_image',
    'uid' => '1',
    'langcode' => Language::LANGCODE_NOT_SPECIFIED,
    'status' => '1',
    'field_utexas_media_image' => [
      'target_id' => $file->id(),
      'alt' => $image_metadata['alt_text'],
      'title' => $image_metadata['title_text'],
    ],
  ]);
  $image_media->save();
  return $image_media->id();
}

/**
 * Helper function to create a Profile node.
 *
 * @param array $data
 *   Key-value array of field data.
 */
function _utprof_content_type_profile_create_node(array $data) {
  $node = Node::create(['type' => 'utprof_profile']);
  $node->set('title', $data['title']);
  $node->set('uid', '1');
  foreach ($data['fields'] as $machine_name => $field_data) {
    $node->set($machine_name, $field_data);
  }
  foreach ($data['profile_groups'] as $group_name) {
    $term = \Drupal::entityTypeManager()->getStorage('taxonomy_term')
      ->loadByProperties(['name' => $group_name, 'vid' => 'utprof_groups']);
    $group = reset($term);
    $group_tids[] = $group->id();
  }
  $node->set('field_utprof_profile_groups', $group_tids);
  if (isset($data['basic_media'])) {
    $media_mid = _utprof_content_type_profile_create_media($data['basic_media']);
    $node->set('field_utprof_basic_media', $media_mid);
  }
  $node->status = 1;
  $node->enforceIsNew();
  $node->save();
}
